---
title: "Exploratory Analyses of Missingness in Meta-Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This vignette demonstrates some numerical and visualization tools to summarize and explore missingness in a meta-analytic dataset. 
The code used in this vignette is implemented in the `R` software language and is based on the `naniar` and `visdat` libraries.
Additional functions are stored in the `wrappers.R` library.

The purpose of this vignette is to demonstrate various useful tools in understanding missingness in a meta-analytic dataset.
As such, it is a companion to the article by [AUTHORS].
However, it is important to note that while the tools presented here are likely useful for many datasets, they are not exhaustive.


# Data

This vignette uses data on substance abuse interventions for adolescents (Tanner-Smith et al., 2016). 
These data comprise 328 distinct effects of substance abuse interventions on future substance use. 
Effects arise from 46 studies, and are accompanied by information about estimated treatment effects and variances, as well as over three dozen variables describing how and where the intervention was implemented. 
While none of the effect estimates are missing, there is missingness on some 18 other variables of interest, including the sample composition of studies and the duration and intensity of the intervention.

Each effect is a contrast between two groups in the study, which are referred to as *Group 1* and *Group 2* in this vignette. 
Variables corresponding to Group 1 in the data have names that start with *g1*, while variables corresponding to Group 2 have names that start with *g2*.

 
# Load Data and Relevant Code Libraries

We start by loading the necessary packages
```{r, message=FALSE}
# libraries for visualizations
library(naniar)
library(visdat)

# code to extend libraries for meta-analysis
source("../code/wrappers.R")

# library for data wrangling and plotting
library(tidyverse)

# read in data
adt_data <- readRDS("../data/adt_data.RDS")
```


# Summary Visualizations with `visdat`

The `visdat` library visuales the entire data frame at once.
```{r, message=FALSE}
# summary plots using vis_dat and vis_miss
gg_summary_covariate_miss(adt_data)
```

The left plot presents a summary of the dataset structure while highlighting variables with missing data; we can initially identify 18 variables of interest with some missingness. Further, we get a better idea of how much data is missing by looking at the second plot (6.2%). 


# Summarizing Missingness with `naniar`

The `naniar` package also provides an approach to visualizing overall missingness of the dataset.

We can plot the number of cases missing a given variable.
```{r}
# summary of missing variables
gg_miss_var(adt_data) +
  labs(y="Missing Cases") +
  theme(axis.title.x = element_text(size =10),
        axis.text.y = element_text(size=6))
```

Alternatively, we can plot the proportion of cases missing a given variable.
```{r}
# summary of missing variables (percentage)
gg_miss_var(adt_data, show_pct=TRUE) +
  labs(y="Percentage Missing") +
  theme(axis.title.x = element_text(size =10),
        axis.text.y = element_text(size=6))
```

We can also look at the number of missing values in each case. 
```{r}
# missingness in cases. Number of missing values in each case
gg_miss_case(adt_data, order_cases=TRUE) + labs(x="Number of Cases")
```

Other summary plots show cumulative counts of cells in the data missing data. 
This plot shows the cumulative count of missing fields as a function of case number (i.e., by reading the data from the top row to the bottom).
```{r}
#cumulative sum of missing values
gg_miss_case_cumsum(adt_data)
```

This plot shows the cumulative count of missing fields as a function of the variables in the data (i.e., by reading the data from left to right).
```{r, echo=FALSE}
#cumulative sum of missing values
gg_miss_var_cumsum(adt_data)
```


# Explore Missingness Across Categorical Variables

It will often be of interest whether missingness is correlated with the value of observed variables. 
The following plots show the number of missing cases versus the level of care given to Group 1 (top plot) and Group 2 (bottom plot) in the data.
Each sub-plot corresponds to a level of care, and the number of cases that are missing different numbers of variables. 
```{r, message=FALSE, message = FALSE, warning = FALSE}
# level of care group 1
gg_miss_case(adt_data, facet=g1loc)

# level of care group 2
gg_miss_case(adt_data, facet=g2loc)
```

A similar type of plot shows the percentage of rows missing data as a function of the levels of a given variable:
```{r}
# level of care group 2
gg_miss_fct(x=adt_data, fct=g2loc) +
  labs(x="Group 2 Level of Care") +
  theme(axis.text.y = element_text(size=7))
```



# Missingness Patterns

A key tool in examining missingness patterns is the upset plot, which reveals which combinations of variables are often missing from the same cases. 
```{r}
gg_miss_upset(adt_data, nsets=11, nintersects=NA)
```


# Missingness and Effect Size Estimates

A key relationship to examine is whether missingness is correlated with effect sizes or standard errors of effect size estimates. 
A useful object for studying this is a `shadow` data frame that includes columns that indicate whether a variable is missing.
First, we will use the shadow function to keep track of missing values. Create a dataframe with the same set of columns, but with the column names added a suffix_NA
```{r}
# build shadow data frame
adt_shadow <- bind_shadow(adt_data)
```

Using the shadow data frame, the following code, implemented in the `wrappers.R` script visualizes potential relationships between missingness and effect size estimates. 
Each figure contains a pair of plots, and each plot shows the density of the effect sizes or standard errors colored according to whether a specified covariate is missing.
```{r}
# missingness in group 1 hours per week
gg_esse_covariate_miss(adt_shadow,
                       es_col = "es_g",
                       se_col = "se_g",
                       covariate = "g1hrsperweek",
                       adjust = c(1.3, 1.2), # Adjust smoothing for ES and SE densitites
                       label = "Group 1 Hrs Per Week")

# missingness in group 1 duration of treatment 
gg_esse_covariate_miss(adt_shadow,
                       es_col = "es_g",
                       se_col = "se_g",
                       covariate = "g1txdays",
                       adjust = c(1.3, 1.2), 
                       label = "Group 1 Duration of Treatment (Days)")


# missingness in group 2 hours per week
gg_esse_covariate_miss(adt_shadow,
                       es_col = "es_g",
                       se_col = "se_g",
                       covariate = "g2hrsperweek",
                       adjust = c(1.3, 1.2), 
                       label = "Group 2 Hrs Per Week")
```

An alternative to the above plots is to build more traditional forest plots, common in most meta-analyses, that shade effects according to whether a covariate is missing. 
To better demonstrate this visualization, we select a subset of the shadow data frame:
This chunk does forest plots shaded by missingness
```{r}
# adt_shadow %>%
#   sample_frac(.5) %>% # select subset of data
  gg_forest_covariate_miss(
    adt_shadow %>% sample_frac(.5), # subset of the data
    es_col = "es_g",
    se_col = "se_g",
    covariate = "g1hrsperweek",
    label = "Group 1 Hrs \nPer Week"
    )
```



Start with Treatment Contact (hours per week) for group 1 and 2
```{r}
# effect size vs group 1 hours per week
ggplot(adt_data) +
  aes(x = g1hrsperweek,
      y = es_g) +
  geom_miss_point(alpha = .8) +
  scale_color_manual("Group 1 Hrs Per Week", 
                     values = c("#56B4E9", "#E69F00"))


# effect size vs group 1 hours per week
# with points sized by SE
pointsize <- 1/adt_data$se_g^2 / (sum(1/adt_data$se_g^2))
ggplot(adt_data) +
  aes(x = g1hrsperweek,
      y = es_g) +
  geom_miss_point(alpha = .5, 
                  size = pointsize) +
  scale_color_manual("Group 1 Hrs Per Week", 
                     values = c("#56B4E9", "#E69F00"))
```

# Numerical Summaries

Finally, there are various numerical summaries of missingness, including the number, proportion, and weighted percent of cases with missing values.

```{r}
# total number of missing observations
n_miss(adt_data) 

# total number of complete observations
n_complete(adt_data)

# proportion missing
prop_miss(adt_data)

# proportion complete
prop_complete(adt_data)

#Percentage missing
pct_miss(adt_data)

#Percentage complete
pct_complete(adt_data)
```


It is also possible to examine missingness by study.
```{r}
#Percentage missing by variable
miss_var_summary(adt_data)

# Same thing, but with a wrapper function for weighted percents
mis_ma_var_summary(adt_data, "se_g", truncate = FALSE)

#Percentage missing by case (Study)
miss_case_summary(adt_data)
```
