---
title: "Understanding Missing Data in Meta-Analyses. Visualization Tutorial"
author: ""
date: "3/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction

We use and extend R's naniar package to demonstrate how visualizations typically used with datasets outside of meta-analysis can be adapted to the realities of meta-analytic data (Tierney, 2019). 

To demonstrate approaches to examining and diagnosing missingness, we use data on substance abuse interventions for adolescents (Tanner-Smith et al., 2016). These data comprise 328 distinct effects of substance abuse interventions on future substance use. These effects arise from 46 studies, and include information about estimated treatment effects and variances, as well as over three dozen variables describing how and where the intervention was implemented. While none of the effect estimates are missing, there is missingness on some 18 other variables of interest, including the sample composition of studies and the duration and intensity of the intervention.
 

## load data and packages

We start by loading the necessary packages
```{r, message=FALSE}
library(naniar)
library(ggplot2)
library(visdat)
library(tidyverse)
adt_data<- readRDS("adt_data.rds")
```

##Looking at missing data with visdat

The package visdat allows visualizing the entire data frame at once.
```{r, message=FALSE}
#Visualize whole dataframe at once
vis_dat(adt_data)
#summary of whether the data is missing or not
vis_miss(adt_data)
```


Both plots show how none of the effect estimates are missing, but that there is missingness on some 18 other variables of interest.

##Looking at missing data with naniar

Naniar package also provides an approach to visualizing overall missingness of the dataset.

For example, we can identify variables that present a greater number (percentage) of missing cases
```{r}
#summary of missing variables
gg_miss_var(adt_data) + labs(y="Look at all the missing ones")

#summary of missing variables (percentage)
gg_miss_var(adt_data, show_pct=TRUE)

```

We can also look at the number of missing values in each case. 
```{r}
#missingness in cases. Number of missing values in each case
gg_miss_case(adt_data, order_cases=TRUE) + labs(x="Number of Cases")
```


Then, the cumulative sum of missing values by reading the rows of the dataset from the top to the bottom.
```{r}
#cumulative sum of missing values
gg_miss_case_cumsum(adt_data)
```

Cumulative sum of missing values reading columns from the left to the right of your dataframe
```{r}
#cumulative sum of missing values
gg_miss_var_cumsum(adt_data)
```


##Explore Missingness across factors

Explore the missingness in cases over some factor variable. For example, let's look at missingness over The Level of Care for each group.
```{r, message=FALSE}
#Level of care group 1
gg_miss_case(adt_data, facet=g1loc)

#Level of care group 2
gg_miss_case(adt_data, facet=g2loc)
```

We then look at the number of missings in each column, broken down by a factor variable, in this case the Level of Care for group 2. 
```{r}
#Level of care group 2
gg_miss_fct(x=adt_data, fct=g2loc)
```

##Combinations of missingness across cases

Further, we can create an upset plot to examine the combinations of missingness across cases
```{r}
gg_miss_upset(adt_data)
```


We could also set the number of sets to 11, which is the number of variables that have at least 5 missing points. 
```{r}
gg_miss_upset(adt_data, nsets=11, nintersects=NA)
```


##Explore missingness relationships with naniar

We can now explore variables that have larger percentage of missing data and their relationship with Effect Size g and Standard Error g

Start with Treatment Contact (hours per week) for group 1 and 2
```{r}
#Treatment contact for group 1 and 2 
#ES and Group 1 Treatment contact (Hours per week)
ggplot(adt_data, 
       aes(x= g1hrsperweek, 
           y=es_g)) + 
  geom_miss_point()

#ES and Group 2 Treatment contact (Hours per week)
ggplot(adt_data, 
       aes(x= g2hrsperweek, 
           y=es_g)) + 
  geom_miss_point()
```


Duration of Treatment (days) for group 1 and 2
```{r}
#Treatment Duration for group 1 and 2
#ES and Group 1 Duration of Treatment (Days)
ggplot(adt_data, 
       aes(x= g1txdays, 
           y=es_g)) + 
  geom_miss_point()

#ES and Group 2 Duration of Treatment (Days)
ggplot(adt_data, 
       aes(x= g2txdays, 
           y=es_g)) + 
  geom_miss_point()

#se and Group 2 Duration of Treatment (Days)
ggplot(adt_data, 
       aes(x= g2txdays, 
           y=se_g)) + 
  geom_miss_point()

```


Frequency of treatment contact per week (number of sessions) for group 2
```{r}
#Frequency of treatment contact per week (number of sessions)
#ES and group 2 number of sessions
ggplot(adt_data, 
       aes(x= g2numsessions, 
           y=es_g)) + 
  geom_miss_point()
```


Percentage of male participants for group 1 and 2
```{r}
#ES and group 1 male percentage
ggplot(adt_data, 
       aes(x= g1perblack, 
           y=es_g )) + 
  geom_miss_point()

#ES and group 2 male percentage
ggplot(adt_data, 
       aes(x= g2perblack, 
           y=es_g )) + 
  geom_miss_point()
```


We could also examine these relationships by looking at the distribution of ES, plotting for values of ES when some covariates are missing, and when they are not. 

First, we will use the shadow function to keep track of missing values. Create a dataframe with the same set of columns, but with the column names added a suffix_NA
```{r}
as_shadow(adt_data)
#Attach a shadow to the current dataframe
adt_shadow <- bind_shadow(adt_data)
```


Start by looking at the distribution of ES, plotting for values of ES when Treatment Contact (Hours per week) is missing, and when it is not missing
```{r}
#ES and Group 1 Treatment contact (Hours per week)
ggplot(adt_shadow,
       aes(x =  es_g,
           colour =g1hrsperweek_NA )) + 
  geom_density()


#ES and Group 2 Treatment contact (Hours per week)
ggplot(adt_shadow,
       aes(x =  es_g,
           colour =g2hrsperweek_NA )) + 
  geom_density()
```


Now the distribution of ES, plotting for values of ES when Duration of Treatment (days) is missing, and when it is not missing
```{r}
#ES and Group 1 Duration of Treatment (Days)
ggplot(adt_shadow, 
       aes(x= es_g, 
           colour=g1txdays_NA)) + 
    geom_density()

#ES and Group 2 Duration of Treatment (Days)
ggplot(adt_shadow, 
       aes(x=es_g , 
           colour=g2txdays_NA)) + 
    geom_density()
```



##Numerical summaries for missing data

Finally, we explore numerical summaries using this package

First, determine number, proportion, and percentage of missing and complete observations
```{r}

#Total number of missing observations
n_miss(adt_data)

#Total number of complete observations
n_complete(adt_data)

#Proportion missing
prop_miss(adt_data)

#Proportion complete
prop_complete(adt_data)

#Percentage missing
pct_miss(adt_data)

#Percentage complete
pct_complete(adt_data)
```

Second, determine percentage missing by variable and case (study)
```{r}
#Percentage missing by variable
miss_var_summary(adt_data)

#Percentage missing by case (Study)
miss_case_summary(adt_data)
```
